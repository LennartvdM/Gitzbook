<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ pageTitle }} â€” {{ bookTitle }}</title>
  <link rel="stylesheet" href="{{ basePath }}assets/theme.css">
  <link rel="stylesheet" href="{{ basePath }}assets/highlight.css" id="hljs-theme">
  <link rel="stylesheet" href="{{ basePath }}assets/highlight-dark.css" id="hljs-dark-theme" disabled>
  {{ extraHead }}
</head>
<body>
  {{ extraBodyStart }}
  <button class="sidebar-toggle" aria-label="Toggle sidebar">&#9776;</button>

  <div class="book-wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1><a href="{{ basePath }}index.html">{{ bookTitle }}</a></h1>
        <div class="sidebar-controls">
          {{ versionSwitcher }}
          {{ localeSwitcher }}
          <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
            <span class="theme-icon-light">&#9788;</span>
            <span class="theme-icon-dark">&#9790;</span>
          </button>
        </div>
      </div>
      <div class="search-wrapper" style="position: relative;">
        <input type="text" id="search-input" placeholder="Search... (/ or Ctrl+K)" autocomplete="off">
        <div class="search-results" id="search-results"></div>
      </div>
      <div class="sidebar-scroll">
        {{ sidebar }}
      </div>
    </aside>

    <main class="main-content">
      <div class="content-wrapper">
        <div class="page-content">
          {{ breadcrumbs }}
          {{ content }}
          {{ prevNext }}
        </div>
        {{ toc }}
      </div>
    </main>
  </div>

  <div class="reload-indicator" id="reload-indicator">Reloading...</div>

  <script src="{{ basePath }}assets/search.js"></script>
  <script>
    // Sidebar toggle for mobile
    document.querySelector('.sidebar-toggle').addEventListener('click', function() {
      document.querySelector('.sidebar').classList.toggle('open');
    });

    // Expand parent nav items that contain the active link
    document.querySelectorAll('.nav-item.expanded > .nav-children').forEach(function(el) {
      el.classList.add('expanded');
    });

    // Make all nav sections with children collapsible
    document.querySelectorAll('.nav-item').forEach(function(item) {
      var children = item.querySelector('.nav-children');
      if (!children) return;
      var link = item.querySelector('a, .nav-group-title');
      if (!link) return;
      link.addEventListener('click', function(e) {
        if (item.classList.contains('active')) return;
        if (link.tagName === 'SPAN') {
          e.preventDefault();
          children.classList.toggle('expanded');
          item.classList.toggle('expanded');
        }
      });
    });

    // Dark mode toggle
    (function() {
      var toggle = document.querySelector('.theme-toggle');
      var html = document.documentElement;
      var hljsLight = document.getElementById('hljs-theme');
      var hljsDark = document.getElementById('hljs-dark-theme');
      var stored = localStorage.getItem('gitzbook-theme');

      function setTheme(dark) {
        if (dark) {
          html.setAttribute('data-theme', 'dark');
          if (hljsLight) hljsLight.disabled = true;
          if (hljsDark) hljsDark.disabled = false;
          localStorage.setItem('gitzbook-theme', 'dark');
        } else {
          html.removeAttribute('data-theme');
          if (hljsLight) hljsLight.disabled = false;
          if (hljsDark) hljsDark.disabled = true;
          localStorage.setItem('gitzbook-theme', 'light');
        }
      }

      // Initialize from stored preference or system preference
      if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setTheme(true);
      }

      if (toggle) {
        toggle.addEventListener('click', function() {
          var isDark = html.getAttribute('data-theme') === 'dark';
          setTheme(!isDark);
        });
      }
    })();

    // Copy-to-clipboard on code blocks
    (function() {
      document.querySelectorAll('pre.hljs').forEach(function(pre) {
        var btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.setAttribute('aria-label', 'Copy code to clipboard');
        pre.style.position = 'relative';
        pre.appendChild(btn);
        btn.addEventListener('click', function() {
          var code = pre.querySelector('code');
          var text = code ? code.textContent : pre.textContent;
          navigator.clipboard.writeText(text).then(function() {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(function() {
              btn.textContent = 'Copy';
              btn.classList.remove('copied');
            }, 2000);
          });
        });
      });
    })();

    // Tabbed code blocks
    (function() {
      document.querySelectorAll('.code-tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var group = btn.closest('.code-tabs');
          var tabId = btn.getAttribute('data-tab');
          // Deactivate all in group
          group.querySelectorAll('.code-tab-btn').forEach(function(b) { b.classList.remove('active'); });
          group.querySelectorAll('.code-tab-panel').forEach(function(p) { p.classList.remove('active'); });
          // Activate selected
          btn.classList.add('active');
          var panel = group.querySelector('[data-panel="' + tabId + '"]');
          if (panel) panel.classList.add('active');
        });
      });
    })();

    // Table of contents scroll spy
    (function() {
      var tocLinks = document.querySelectorAll('.toc-item a');
      if (tocLinks.length === 0) return;

      var headings = [];
      tocLinks.forEach(function(link) {
        var id = link.getAttribute('href').slice(1);
        var el = document.getElementById(id);
        if (el) headings.push({ el: el, link: link });
      });

      function onScroll() {
        var scrollTop = window.scrollY + 100;
        var active = null;
        for (var i = headings.length - 1; i >= 0; i--) {
          if (headings[i].el.offsetTop <= scrollTop) {
            active = headings[i];
            break;
          }
        }
        tocLinks.forEach(function(l) { l.parentElement.classList.remove('active'); });
        if (active) active.link.parentElement.classList.add('active');
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();
  </script>
  {{ liveReloadScript }}
  {{ extraBodyEnd }}
</body>
</html>
